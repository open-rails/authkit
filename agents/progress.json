{
  "issues": [
    {
      "name": "Move ephemeral auth state to Redis (codes, SIWS challenges, rate limits)",
      "description": "Use Redis-compatible storage (Garnet) for ephemeral auth state (verification codes, reset tokens, SIWS challenges, and other short-lived entries) so we don't rely on Postgres TTL cleanup. This also makes SIWS safe in multi-instance deployments. In-memory caches remain as a fallback when Garnet is not configured, but they are not safe for distributed use. AuthKit should accept a Redis client interface from the host app (Garnet implements the same protocol).",
      "tasks": [
        "[x] Define a minimal Redis client interface (Get/Set/Del) and accept it via AuthKit options",
        "[x] Add Garnet/Redis config in host apps; pass client into AuthKit (no internal dialer)",
        "[x] Define key prefixes + TTLs for: email/phone verify codes, password resets, pending registrations, 2FA codes, SIWS challenges, rate limit buckets",
        "[x] Replace Postgres writes for ephemeral tables with Redis writes (keep Postgres for durable user/session records)",
        "[x] Update verification flows to read from Redis and delete on success",
        "[x] Add store selection: memory|redis|postgres (configurable). Memory is dev-only; redis required for multi-instance prod; postgres is explicit opt-in adapter",
        "[x] Enforce: in prod + multi-instance, require redis; otherwise fail fast with clear error",
        "[x] Keep in-memory cache fallback for dev/single-instance",
        "[x] Update migrations/docs: remove ephemeral tables or leave for backward compat; document required Redis for HA",
        "[x] Add tests for Redis-backed flows (skip when Redis not configured)"
      ],
      "completed": true
    },
    {
      "name": "Unify OAuth/OIDC routes under /auth/oauth/:provider",
      "description": "Expose a single route pattern for all external identity providers (OIDC and OAuth) under /auth/oauth/:provider to simplify client integration while keeping provider-specific logic internally.",
      "tasks": [
        "[ ] Add new routes: GET /auth/oauth/:provider/login, GET /auth/oauth/:provider/callback, POST /auth/oauth/:provider/link/start",
        "[ ] Wire OIDC providers (google/apple/etc) to the new /auth/oauth/:provider routes without changing internal validation flow",
        "[ ] Wire Discord OAuth to the same /auth/oauth/:provider routes",
        "[ ] Decide whether to keep /auth/oidc/* and /auth/oauth/discord/* as aliases or deprecate with docs",
        "[ ] Update docs (api-endpoints.md) with new unified route pattern and provider list"
      ],
      "completed": false
    },
    {
      "name": "Add phone number change flow (request/confirm/resend)",
      "description": "Add a phone change flow for existing users mirroring the email change behavior. This should verify the new phone number via SMS code and update the user's phone only after confirmation.",
      "tasks": [
        "[ ] Add core service methods: RequestPhoneChange(userID, newPhone), ConfirmPhoneChange(userID, code), ResendPhoneChangeCode(userID)",
        "[ ] Add persistence for pending phone change verification (reuse phone_verifications with a new purpose or add a dedicated table)",
        "[ ] Add Gin handlers: POST /auth/user/phone/change/request, POST /auth/user/phone/change/confirm, POST /auth/user/phone/change/resend",
        "[ ] Add rate limit keys for request/confirm/resend",
        "[ ] Update docs (api-endpoints.md) with phone change routes and expected errors"
      ],
      "completed": false
    },
    {
      "name": "Add phone verification request endpoint",
      "description": "Add POST /auth/phone/verify/request endpoint for existing users to add/verify a phone number, mirroring the existing POST /auth/email/verify/request flow.",
      "tasks": [
        "[DONE] Add RequestPhoneVerificationByPhone() method to core/service.go",
        "[DONE] Create phone_verify_request_post.go handler",
        "[DONE] Add rate limit constant RLPhoneVerifyRequest to ginutil",
        "[DONE] Wire up route in service.go GinRegisterAPI",
        "[DONE] Update api-endpoints.md documentation"
      ],
      "completed": true
    },
    {
      "name": "Enhance UserContext with convenience methods",
      "description": "Both doujins and hentai0 wrap authkit's UserContext with their own logic to check roles/entitlements. This should be built into authkit's UserContext directly.\n\n## Problem\n\ndoujins has `internal/auth/user_context.go` with:\n```go\ntype UserContext struct {\n    User         *views.User  // Project-specific\n    IsAdmin      bool\n    IsLoggedIn   bool\n    Language     string\n    Roles        []string\n    Entitlements []string\n}\n```\n\nAnd `internal/middleware/user_context.go` computes these flags:\n```go\nuserCtx.IsAdmin = containsIgnoreCase(userCtx.Roles, \"admin\")\n```\n\nhentai0 uses authkit's UserContext directly but lacks these convenience methods.\n\n## Solution\n\nAdd convenience methods to authkit's `UserContext` in `adapters/gin/userctx.go`:\n\n```go\n// Already exists:\nfunc (uc UserContext) IsAdmin() bool { return hasString(uc.Roles, \"admin\") }\n\n// Add these:\nfunc (uc UserContext) IsLoggedIn() bool { return uc.UserID != \"\" }\nfunc (uc UserContext) HasRole(role string) bool { return hasString(uc.Roles, role) }\nfunc (uc UserContext) HasEntitlement(ent string) bool { return hasString(uc.Entitlements, ent) }\n```\n\n## Important: NO IsPremium() method\n\nDo NOT add `IsPremium()` method. This is overly specific and doesn't scale. Instead, callers should use the generic `HasEntitlement(\"premium\")`. Same logic applies to any future entitlement types - use the generic method, not dedicated boolean methods.\n\n## Migration\n\nAfter authkit changes:\n- doujins can simplify `internal/middleware/user_context.go` to just use `authgin.UserContext` methods\n- doujins can potentially remove `internal/auth/user_context.go` if the only additions were computed flags\n- hentai0 gains these methods automatically\n\n## Note\n\nLanguage middleware and response envelopes are NOT part of this issue - those belong in a separate shared library (e.g., `go-api-common`), not authkit.",
      "tasks": [
        "[x] Add IsLoggedIn() method to UserContext (check UserID != \"\")",
        "[x] Add HasRole(role string) method to UserContext",
        "[x] Add HasEntitlement(ent string) method to UserContext",
        "[x] Add unit tests for new UserContext methods",
        "[x] Downstream app wrapper removal tracked in app repos"
      ],
      "completed": true
    }
  ],
  "completed_features": [
    {
      "name": "Sign In With Solana (SIWS)",
      "completed_at": "2025-12-04",
      "summary": "Implemented SIWS authentication with challenge/login/link endpoints, Ed25519 signature verification, and nonce-based replay protection."
    }
  ]
}
