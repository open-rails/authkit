{
  "issues": [
    {
      "name": "Auth magic links for verification + password reset (standard policy; not configurable)",
      "id_number": 10,
      "description": "AuthKit currently supports email verification and password reset via short codes (generated + stored server-side) and dispatches them via host-provided sender interfaces.\n\nAdd support for URL-based one-time **magic links** for BOTH:\n- email verification (in addition to codes)\n- password reset (LINKS ONLY; remove code-based password reset)\n\nStandard policy (not configurable in AuthKit):\n- Email:\n  - verification: code + link\n  - password reset: link-only\n- SMS:\n  - verification: code-only (Twilio Verify)\n  - password reset: link-only (Twilio Messaging/SMS API; not Verify)\n- 2FA/login: code-only\n\nSMS note:\n- Twilio Verify is OTP/code-based. Use it for phone verification and login/2FA codes.\n- Password reset links over SMS should be sent via Twilio Messaging/SMS API (not Verify) and are in-scope for this issue.\n\n## Key UX notes (host app)\n\n- Link clicks should land in a host-owned page (frontend) for best UX:\n  - Verify: a page that shows \"verified\" (or auto-logs in if appropriate)\n  - Reset: a page that prompts for a new password\n- Those pages typically take `token` as a query param and call AuthKit to consume it.\n\nAuthKit can also optionally implement a server-side redirect after consuming the token, but redirects must be safe (no open-redirect).\n\n## Proposed design\n\n### 1) Token generation + storage (hashed, single-use)\n\n- Generate a random high-entropy token (e.g. 32 bytes), encode base64url.\n- Store only a hash server-side (e.g. SHA-256) in the existing ephemeral store (Redis preferred; in-memory dev fallback).\n- Bind the token to purpose + subject:\n  - verify-email: bind to user_id (or pending registration identifier) and/or email\n  - reset-password: bind to user_id\n- TTL default: 15 minutes.\n- Single-use: delete on successful consume.\n\n### 2) HTTP endpoints to consume link tokens\n\nAdd public endpoints:\n- `POST /auth/email/verify/confirm-link` (body: `{token}`) -> JSON response for SPA/mobile\n- `GET /auth/email/verify/confirm-link?token=...` -> optional convenience path that can 302 redirect\n\n- `POST /auth/password/reset/confirm-link` (body: `{token, new_password}`) OR a two-step reset:\n  - `POST /auth/password/reset/validate-link` (body: `{token}`) -> returns ok + maybe email hint\n  - `POST /auth/password/reset/confirm-link` (body: `{token, new_password}`)\n\nRedirects:\n- Either no redirect param (fixed redirect) OR allowlist exact origins/paths.\n\n### 3) Delivery policy (fixed)\n\nAuthKit enforces the standard policy above. Host apps still control what they include in messages because they own templates, but AuthKit will only generate/accept tokens consistent with the policy.\n\n### 4) Sender interface extensions (backward compatible)\n\nIntroduce optional interfaces (host can implement some/all):\n- `EmailSenderWithLinks`:\n  - `SendEmailVerificationLink(ctx, email, username, verifyURL, code string) error`\n  - `SendPasswordResetLink(ctx, email, username, resetURL string) error`\n- `SMSSenderWithPasswordResetLink` (separate from Twilio Verify):\n  - `SendPasswordResetLink(ctx, phone, resetURL string) error`\n\nAuthKit behavior:\n- Email verification: send code (existing EmailSender) AND send link when EmailSenderWithLinks is implemented.\n- Password reset (email): send link only; require EmailSenderWithLinks to be implemented (no code fallback).\n- SMS verification: code-only via Twilio Verify.\n- Password reset (SMS): send link only via Twilio Messaging/SMS API; require SMSSenderWithPasswordResetLink.\n\n## Security hardening (magic links)\n\n- Token must be high entropy (e.g. 32 bytes), single-use, short TTL, and stored server-side as a hash.\n- Avoid open redirects (no arbitrary redirect URL; use fixed redirect or allowlist).\n- Minimize token leakage:\n  - Don't log tokens.\n  - Avoid placing token in any third-party request path (analytics, images, scripts) before it's consumed.\n  - Consider referrer/URL leakage: prefer POST-based consume from the frontend page, and keep the reset/verify landing page free of third-party resources.\n  - Treat forwarded links/screenshots as a risk; single-use + TTL mitigates.\n\n### 5) Docs + security\n\n- Document new endpoints and host expectations.\n- Rate limit token consumption endpoints by IP and token hash prefix.\n- Ensure tokens are one-time and short-lived.\n- Avoid leaking whether an email/phone exists (same behavior as code flows).\n\n## Tasks\n\n- [ ] Define token formats + binding fields for verify-email and reset-password links\n- [ ] Implement create/consume helpers in core using ephemeral store (hash only)\n- [ ] Add Gin handlers/routes for verify-email link confirm + password reset link flows (JSON + optional redirect)\n- [ ] Add rate limit keys for all new endpoints\n- [ ] Add tests: token generation/consume + handlers (success/expired/invalid)\n- [ ] Update `agents/api-endpoints.md` + README with flows + security guidance",
      "tasks": [
        "[ ] Define token formats + binding fields for verify-email and reset-password links",
        "[ ] Implement create/consume helpers in core using ephemeral store (hash only)",
        "[ ] Implement SMS password reset link sender using Twilio Messaging/SMS API (separate from Twilio Verify)",
        "[ ] Remove/disable code-based password reset flow (keep codes for verification + 2FA only)",
        "[ ] Add Gin handlers/routes for verify-email link confirm + password reset link flows (JSON + optional redirect)",
        "[ ] Add rate limit keys for all new endpoints",
        "[ ] Add unit tests for create/consume + handler tests",
        "[ ] Docs: clarify host app constructs user-facing URLs (site base URL + chosen frontend routes); AuthKit only issues/consumes tokens",
        "[ ] Document endpoints + host integration guidance",
        "[ ] Enforce standard policy (no per-app config): email verify=code+link; email reset=link-only; SMS verify=code-only; SMS reset=link-only",
        "[ ] Add optional sender interface (EmailSenderWithLinks) + wiring for EMAIL links"
      ],
      "completed": false
    }
  ]
}
